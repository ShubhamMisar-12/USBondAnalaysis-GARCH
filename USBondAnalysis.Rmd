---
title: "USBondAnalysis"
author: "Shubham Misar"
date: "2023-06-17"
output: html_document
---

```{r}
library(tsibble)
library(dplyr)
library(ggplot2)
library(fabletools)
library(feasts)
library(tsibbledata)
library(forecast)
library(tidyverse)


```

## Data Preprocessing

```{r}
df <- read.csv("FED-SVENY.csv")
```

```{r}
head(df)
```

Lets Convert the Date column into datetime format and make it into index

```{r}
df<-df %>% 
  mutate(Date = as.Date(Date)) %>% 
  as_tsibble(index = Date)
```

```{r}
head(df)
```

## EDA

```{r}
df %>% 
  autoplot(SVENY01) +
  labs(
    x = "Date",
    y = "1 Year Bond",
    title = "1 Year Bond Returns"
  )
```

```{r}
df_long <- df %>%
  pivot_longer(cols = -Date, names_to = "Variable", values_to = "Value")
```

```{r, warning=FALSE}
library(ggplot2)
library(ggthemes)

df_long %>%
  ggplot(aes(x = Date, y = Value, color = Variable)) +
  geom_line(linetype = "solid", size = 1.5) +  
  scale_color_viridis_d() +  
  labs(
    x = "Date",
    y = "Bond Yield in %",
    title = "Bond Yield Comparison"
  ) +
  theme_minimal() +  
  theme(
    plot.title = element_text(size = 16, face = "bold"),  
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),  
    legend.title = element_blank(),  
    legend.position = "bottom"  
  )

```

As the term for investment increases the returns are higher.

During the 1980s The investment percentage was the highest.

Lets choose SVENY01, SVENY07 and SVENY20 to forecast 

```{r}
date_range <- data.frame(Date = seq(min(df$Date), max(df$Date), by = "day"))
df_filled <- date_range %>%
  left_join(df, by = "Date") %>%
  fill(everything(), .direction = "down") %>% 
  as_tsibble(index = Date)

```



```{r}
dcap <- df_filled %>%
  model(classical_decomposition = classical_decomposition(SVENY01, type  = 'additive'))
```


```{r}

date_range <- data.frame(Date = seq(min(df$Date), max(df$Date), by = "day"))


df_filled <- date_range %>%
  left_join(df, by = "Date") %>%
  fill(everything(), .direction = "down") %>% 
  as_tsibble(index = Date)


head(df_filled)
```

```{r, fig.height=8}
df_filled %>%
  gg_season(SVENY01, labels = "right") +
  labs(
    title = "Seasonal Pattern of SVENY01",
    x = "Season",
    y = NULL,
    fill = "Year"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top"
  ) +
  guides(color = guide_legend(override.aes = list(size = 1))) +
  guides(fill = guide_legend(override.aes = list(size = 1))) +
  theme(legend.key.size = unit(1, "lines"))



```


The above plot we see around 1970s and 1980s there were high returns, no particular seasonlity 

### Decomposition

### SVENY01

```{r}
dcamp <- df_filled %>%
  model(classical_decomposition = classical_decomposition(SVENY01, type = 'additive')) 
```

```{r, warning=FALSE}
components(dcamp) %>% 
  autoplot()
```

There is no seasonality we see but we see high variance around 1980s.

### SVENY07



```{r}
dcamp <- df_filled %>%
  model(classical_decomposition = classical_decomposition(SVENY07, type = 'additive')) 
```

```{r, warning=FALSE}
components(dcamp) %>% 
  autoplot()
```
More variance than SVENYO1 more on the positive side


### SVENY20

```{r}
dcamp <- df_filled %>%
  model(classical_decomposition = classical_decomposition(SVENY20, type = 'additive')) 
```

```{r, warning=FALSE}
components(dcamp) %>% 
  autoplot()
```

The data is shifting since 2020 lets looks closer.


```{r}
df %>%
  filter( "2020-08-01" > Date & Date > "2019-05-01" ) %>%
  ggplot() +
  geom_line(aes(x = Date, y = SVENY01, color = "SVENY01"), linetype = "solid", size = 0.8) +
  geom_line(aes(x = Date, y = SVENY20, color = "SVENY20"), linetype = "solid", size = 0.8) +
  geom_line(aes(x = Date, y = SVENY07, color = "SVENY07"), linetype = "solid", size = 0.8) +
  geom_line(aes(x = Date, y = SVENY30, color = "SVENY30"), linetype = "solid", size = 0.8) +
  labs(
    x = "Date",
    y = "Bond Yield",
    title = "Bond Yield Comparison Just Before COVID",
    color = "Series",
    linetype = "Series"
  ) +
  scale_color_manual(
    values = c("#0072B2", "#D55E00", "#009E73", "#CC79A7"),
    labels = c("SVENY01", "SVENY20", "SVENY07", "SVENY30")
  ) +
  scale_linetype_manual(
    values = c("solid", "solid", "solid", "solid"),
    labels = c("SVENY01", "SVENY20", "SVENY07", "SVENY30")
  ) +
  theme_minimal() +
  guides(
    color = guide_legend(override.aes = list(linetype = "solid")),
    linetype = guide_legend()
  )


```

Bond values decreased from March 2020 specifically for SVENY01 went down far down.

```{r}
df %>%
  filter(Date > "2022-05-01") %>%
  ggplot() +
  geom_line(aes(x = Date, y = SVENY01, color = "SVENY01"), linetype = "solid", size = 0.8) +
  geom_line(aes(x = Date, y = SVENY20, color = "SVENY20"), linetype = "solid", size = 0.8) +
  geom_line(aes(x = Date, y = SVENY07, color = "SVENY07"), linetype = "solid", size = 0.8) +
  geom_line(aes(x = Date, y = SVENY30, color = "SVENY30"), linetype = "solid", size = 0.8) +
  labs(
    x = "Date",
    y = "Bond Yield",
    title = "Bond Yield Comparison After COVID",
    color = "Series",
    linetype = "Series"
  ) +
  scale_color_manual(
    values = c("#0072B2", "#D55E00", "#009E73", "#FC79B2"),
    labels = c("SVENY01", "SVENY20", "SVENY07", "SVENY30")
  ) +
  scale_linetype_manual(
    values = c("solid", "solid", "solid", "solid"),
    labels = c("SVENY01", "SVENY20", "SVENY07", "SVENY30")
  ) +
  theme_minimal() +
  guides(
    color = guide_legend(override.aes = list(linetype = "solid")),
    linetype = guide_legend()
  )

```

Post Recovery the SVENY01 value went up.


## Moelling

### Check Stationarity

```{r, warning=FALSE}
df %>%
  autoplot(SVENY01 %>% difference(1))
```

```{r, warning=FALSE}
df %>%
  autoplot(SVENY01 %>% difference(7))
```
```{r, warning=FALSE}
df %>%
  autoplot(SVENY01 %>% difference(20))
```

The series is stationary but challenge here is to predict the volatility, as it is important aspect in the financial markets.

Therefore we use GARCH model.

## Analyzing Variance


```{r}
df_filtered <- df_filled %>% 
  filter(Date > '1982-01-01') 
```


```{r}
pacf(df_filtered$SVENY01, lag.max = 20) 
```

```{r}
pacf(df_filtered$SVENY07, lag.max = 20) 
```

```{r}
pacf(df_filtered$SVENY20, lag.max = 20) 
```



```{r}
model <- ts_data %>%
  model(ARIMA = ARIMA(value))

```



We can model GARCH(1,1) model based on the PACF plot.


```{r}
dcamp_01 <- df_filled %>%
  filter(Date > '2010-01-01') %>% 
  model(classical_decomposition = classical_decomposition(SVENY01, type = 'additive')) 

dcamp_07 <- df_filled %>%
  filter(Date > '2010-01-01') %>% 
  model(classical_decomposition = classical_decomposition(SVENY07, type = 'additive')) 

dcamp_20 <- df_filled %>%
  filter(Date > '2010-01-01') %>% 
  model(classical_decomposition = classical_decomposition(SVENY20, type = 'additive')) 
```


```{r warning=FALSE}
library(cowplot)
library(forecast)

plot1 <- components(dcamp_01) %>% 
  autoplot(random) +
  labs(x = "Time", y = "1 Year")

plot2 <- components(dcamp_07) %>% 
  autoplot(random) +
  labs(x = "Time", y = "7 Year")

plot3 <- components(dcamp_20) %>% 
  autoplot(random) +
  labs(x = "Time", y = "20 Year")

plot_grid(plot1, plot2, plot3, ncol = 1, labels = c("A", "B", "C"))

```

## Modelling - GARCH

```{r}
library(rugarch)
```


```{r}
df_filtered <- df_filled %>% 
  filter(Date > '2022-01-01')
```


```{r}
pacf(df_filtered$SVENY01, lag.max = 20) 
```

```{r}
pacf(df_filtered$SVENY07, lag.max = 20) 
```



```{r}
pacf(df_filtered$SVENY20, lag.max = 20) 
```

```{r}
spec <-
  ugarchspec(
    variance.model = list(
      model = "sGARCH",
      garchOrder = c(1, 1),
      submodel = NULL,
      external.regressors = NULL,
      variance.targeting = FALSE
    ),
    mean.model = list(armaOrder = c(0, 0),
                      include.mean = TRUE),
    distribution.model = "sged"
  )


gfit <- ugarchfit(spec, df$SVENY01,
                 solver = "hybrid")

```


```{r}
summary(gfit)
```









